<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUS route optimiser</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .card{
            height: auto;
            width: auto;
        }
            @media (min-width: 760px){
                .card{
                height: auto;
                width: auto;
                min-height: 90vh;
            }
        }
        #map {
            height: 65vh;
            width:100%;
            border: 1px solid #333;
            border-radius: 8px; 
        }
            @media (min-width: 760px){
                #map{
                height: auto;
                width: auto;
                min-height: 80vh;

            }
        }
        .suggestion-box {
            position: absolute;
            z-index: 1000;
            background: white;
            width: 95%;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }
        .list-group-item{
            cursor: pointer;
        }
         .list-group-item:hover {
            background-color: #f0f0f0;
        }
        .input-wrapper {
            position: relative; 
        }
        #busResults {
    margin-top: 15px;
    max-height: 50vh; /* Reduced from 60vh to fit better */
    overflow-y: auto;
    padding-right: 5px;
    scrollbar-width: thin; 
}

        .bus-card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #28a745; /* Default Green for Upcoming */
            transition: all 0.2s ease;
            position: relative;
        }

        .bus-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .bus-card.departed {
            border-left-color: #6c757d;
            opacity: 0.7;
            background: #f8f9fa;
        }
        .bus-card.departed .time-main { color: #6c757d; text-decoration: line-through; }

        .bus-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .service-code { font-size: 0.9rem; color: #333; font-weight: 800; letter-spacing: 0.5px; color: red;opacity: 0.8 }
        .service-type { font-size: 0.9rem; font-weight: 800; color: #333; text-transform: uppercase; }
        
        .bus-body { display: flex; align-items: center; justify-content: space-between; }
        .time-group { text-align: center; min-width: 60px; }
        .time-label { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .time-main { font-size: 1.4rem; font-weight: 800; color: #212529; line-height: 1; }
        
        .journey-graphic { flex-grow: 1; display: flex; align-items: center; justify-content: center; color: #ddd; font-size: 1.2rem; padding: 0 10px; position: relative; }
        .bus-icon-circle {
            width: 32px; height: 32px; background: #e6f4ea; color: #28a745;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .departed .bus-icon-circle { background: #eee; color: #777; }

        .status-badge { 
            font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; font-weight: bold; background: #eee; color: #555; 
        }
    .route-info-badge {
    background-color: #212529; 
    color: white; 
    padding: 8px 15px; 
    border-radius: 20px; 
    font-size: 0.9rem; 
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.custom-bus-marker {
    background-color: #dc3545; /* Red */
    border: 2px solid white;
    border-radius: 50%;
    display: flex !important;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
}
.shade-badge {
    display: inline-block;
    background: linear-gradient(135deg, #354a35 0%, #0e1a0e 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    cursor: pointer;
    transition: transform 0.2s;
}

.shade-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(9, 117, 24, 0.4);
}

/* Expandable Details */
.shade-details {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin-top: 10px;
    border: 2px solid #e9ecef;
}

.shade-comparison {
    display: flex;
    gap: 10px;
    margin: 10px 0;
}

.shade-bar {
    flex: 1;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.85rem;
}
/* Timeline Styles for Bus Stops */
.timeline {
    position: relative;
    padding-left: 30px;
    margin: 20px 0;
}
.timeline-item {
    position: relative;
    padding-bottom: 20px;
    border-left: 2px solid #e9ecef;
    padding-left: 20px;
}
.timeline-item:last-child {
    border-left: 2px solid transparent;
}
.timeline-dot {
    position: absolute;
    left: -6px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #dc3545;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #dc3545;
}
.timeline-time {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: bold;
}
.timeline-content {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    margin-top: 5px;
}
.shade-bar.left {
    background: linear-gradient(135deg, #aeb5af 0%, #87e894 100%);
}

.shade-bar.right {
    background: linear-gradient(135deg, #c97f84 0%, #a85d62 100%);
}

.shade-bar.winner {
    border: 3px solid #ffc107;
    transform: scale(1.05);
}

.shade-bar-value {
    font-size: 1.5rem;
    font-weight: 800;
    display: block;
}

.shade-bar-label {
    font-size: 0.75rem;
    opacity: 0.8;
    text-transform: uppercase;
}

    </style>
</head>
<body class="bg-light">

    <div class="container-fluid mt-3">
    <div class="row">
        <!-- LEFT COLUMN: Search + Buses -->
        <div class="col-12 col-lg-6">
            <div class="card shadow mb-3">
                <div class="card-header bg-dark text-white">
                    <h3>Bus Route Finder</h3>
                     <a href="https://hemanthpulicharla.pythonanywhere.com" target="_blank" 
           style="color: #ffc107; text-decoration: none; font-size: 0.9rem; font-weight: 600;"
           onmouseover="this.style.color='#ffeb3b'"
           onmouseout="this.style.color='#ffc107'">
            ‚ö° Hemanth Pulicharla</a>
                </div>
                <div class="card-body">
                    <p>Select locations to find buses and routes.</p>
                    
                    <!-- From Input -->
                    <div class="input-container mb-3 input-wrapper">
                        <label class="fw-bold text-muted">From:</label>
                        <input type="text" id="fromInput" class="form-control" autocomplete="on" oninput="handleInput(this,'from')">
                        <div id="fromSuggestions" class="list-group suggestion-box"></div>
                    </div>
                    
                    <!-- To Input -->
                    <div class="input-container mb-3 input-wrapper">
                        <label class="fw-bold text-muted">To:</label>
                        <input type="text" id="toInput" class="form-control" autocomplete="on" oninput="handleInput(this,'to')">
                        <div id="toSuggestions" class="list-group suggestion-box"></div>
                    </div>
                      <div id="shadeBadge" class="mt-2">
        <span class="shade-badge" id="shadeBadgeContent">
            ‚òÄÔ∏è <span id="preferredSideText">Analyzing shade...</span>
        </span>
    </div>
                    <!-- Bus Results (Right side on desktop, below inputs on mobile) -->
                    <div id="busResults"></div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT COLUMN: Map + Stats -->
        <div class="col-12 col-lg-6">
            <div class="card shadow">
                <div class="card-body">
                    <!-- Route Stats -->
                    <div id="routeStats" class="mb-2 text-center" style="display:none;">
                        <span class="route-info-badge">
                            <span id="distVal">0 km</span>
                            <span style="border-left: 1px solid #555; height: 15px;"></span>
                            <span id="durVal">0 min</span>
                        </span>
                    
                    </div>
                    
                    <!-- Map -->
                    <div id="map"></div>
                    
                    <!-- Reload Button -->
                    <div class="mt-3 text-center">
                        <button class="btn btn-success" onclick="loadRoute()">Reload Route & Zoom</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([20.5937, 78.9629], 5);
       var voyagerLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd',
    maxZoom: 20
});
       var positronLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 20
});
        var osmmap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);


        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        });

        var baseMaps={
            "osmmap":osmmap,
            "VOyager":voyagerLayer,
            "Satelite":satelliteLayer,
            "Apple maps": positronLayer

        }
        var routePolyline=null;
        L.control.layers(baseMaps).addTo(map);

        let fromcoord=null;
        let tocoord=null;
        var fromApsrtcId;
        var toApsrtcId;
        var fromState = null;  // ADD
        var toState = null;

        let debounceTimer;

        function handleInput(inputElement,type){
            clearTimeout(debounceTimer);
            const query=inputElement.value;
            const suggestionBox=document.getElementById(type + 'Suggestions');

            if (query.length <3){
                suggestionBox.innerHTML='';
                return;
            }

        debounceTimer = setTimeout( async() => {
            try{
                const response = await fetch(`api/search?q=${encodeURIComponent(query)}`);
                const suggestions = await response.json();

                suggestionBox.innerHTML = '';

                suggestions.forEach(item => {
                    const div=document.createElement('a');
                    div.className = 'list-group-item list-group-item-action';
                    let stateBadge = '';
    if (item.state === 'KSRTC') {
        stateBadge = '<span class="badge bg-success ms-2">Kerala</span>';
    } else if (item.state === 'TNSTC') {
        stateBadge = '<span class="badge bg-danger ms-2">Tamil Nadu</span>';
    }else if (item.state === 'KSRTC-KA') {
        stateBadge = '<span class="badge bg-warning text-dark ms-2">Karnataka</span>';
    } 
    else if (item.state === 'TGSRTC') {
        stateBadge = '<span class="badge bg-dark ms-2" style="color:#ffc107;">Telangana</span>';
    }
    else {
        stateBadge = '<span class="badge bg-primary ms-2">Andhra Pradesh</span>';
    }
                    div.innerText=item.label;
                    div.onclick=()=>Setlocation(item,type);
                    suggestionBox.appendChild(div);
                });

            }
            catch(err){
                cosole.log("search error",err)
            }

        },300)
    }

async function Setlocation(item, type) {
        document.getElementById(type + 'Input').value = item.label;
        document.getElementById(type + 'Suggestions').innerHTML = '';

        if (type === 'from') {
            fromApsrtcId = null;
            fromcoord = item.coords;
            fromState = item.state;
        } else {
            toApsrtcId = null;
            tocoord = item.coords;
            toState = item.state;
        }

        // --- APSRTC LOGIC ---
        if (item.state === 'APSRTC') {
            try {
                const response = await fetch('/api/resolve-apsrtc-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: item.label, state: item.state })
                });
                const result = await response.json();
                if (result.id) {
                    if (type === 'from') fromApsrtcId = result.id;
                    else toApsrtcId = result.id;
                }
            } catch (err) { console.error("AP Error", err); }
        } 
        
        // --- NEW TGSRTC LOGIC (Fixing the ID mismatch) ---
        else if (item.state === 'TGSRTC') {
            console.log("Resolving ID from Local TGSRTC DB...");
            try {
                const response = await fetch('/api/tgsrtc/resolve-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: item.label })
                });
                
                const result = await response.json();
                
                if (result.id) {
                    if (type === 'from') {
                        fromApsrtcId = result.id; // Using same variable to store ID
                        console.log(`FROM TG ID: ${result.id} (${result.match})`);
                    } else {
                        toApsrtcId = result.id;
                        console.log(`TO TG ID: ${result.id} (${result.match})`);
                    }
                } else {
                    alert("Stop not found in local GTFS database. Try a main bus station name.");
                }
            } catch (err) { console.error("TG Error", err); }
        }

        if (fromcoord && tocoord) { loadRoute(); }
        if (fromState && toState) { searchBuses(); }
    }
    function toggleShadeDetails(shade) {
    let detailsDiv = document.getElementById('shadeDetailsExpand');
    
    if (!detailsDiv) {
        // Create details section if doesn't exist
        detailsDiv = document.createElement('div');
        detailsDiv.id = 'shadeDetailsExpand';
        detailsDiv.className = 'shade-details';
        document.getElementById('shadeBadge').appendChild(detailsDiv);
    }
    
    if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
        // Show details
        detailsDiv.innerHTML = `
            <div class="shade-comparison">
                <div class="shade-bar left ${shade.preferred_side === 'LEFT' ? 'winner' : ''}">
                    <span class="shade-bar-value">${Math.round(shade.left_shade_minutes)}</span>
                    <span class="shade-bar-label">min</span>
                    <div class="mt-1">‚¨ÖÔ∏è Left Side</div>
                </div>
                <div class="shade-bar right ${shade.preferred_side === 'RIGHT' ? 'winner' : ''}">
                    <span class="shade-bar-value">${Math.round(shade.right_shade_minutes)}</span>
                    <span class="shade-bar-label">min</span>
                    <div class="mt-1">‚û°Ô∏è Right Side</div>
                </div>
            </div>
            <div class="text-center mt-2 p-2 bg-white rounded">
                <small><strong>ü™ü Recommendation:</strong> ${shade.preferred_window}</small>
            </div>
        `;
        detailsDiv.style.display = 'block';
    } else {
        // Hide details
        detailsDiv.style.display = 'none';
    }
}
    
   async function loadRoute() {

    if (!fromcoord || !tocoord) {
        alert("Please select from and to locations");
        return;
    }
    document.body.style.cursor = 'wait';
    
    try {
        const response = await fetch('/get_route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/JSON' },
            body: JSON.stringify({ start: fromcoord, end: tocoord })
        });
        const data = await response.json();
        
        console.log("Shade Data:", data.shade_analysis);
        const badgeContainer = document.getElementById('shadeBadge');
        const badgeContent = document.getElementById('shadeBadgeContent');
        const textSpan = document.getElementById('preferredSideText');
        const detailsDiv = document.getElementById('shadeDetailsExpand');

        if (data.shade_analysis) {
            const shade = data.shade_analysis;
            badgeContainer.style.display = 'block'; 

            if (shade.is_night) {
                textSpan.innerHTML = "üåô <strong>Night Journey</strong> - No sun only fun!";
                
                badgeContent.style.background = "linear-gradient(135deg, #0f2027 0%, #203a43 100%)";
                badgeContent.style.cursor = "default";
                
                badgeContent.onclick = null;
                
                if (detailsDiv) detailsDiv.style.display = 'none';

            } else {
                const preferredEmoji = shade.preferred_side === 'LEFT' ? '‚¨ÖÔ∏è' : '‚û°Ô∏è';
                textSpan.innerHTML = `${preferredEmoji} <strong>${shade.preferred_side} side windows</strong> have ${shade.shade_percentage}% shade`;
                
                badgeContent.style.background = "linear-gradient(135deg, #354a35 0%, #0e1a0e 100%)";
                badgeContent.style.cursor = "pointer";
                
              
                badgeContent.onclick = function() {
                    toggleShadeDetails(shade);
                };
            }
        } else {
            badgeContainer.style.display = 'none';
        }

        if (data.path) {
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }

            routePolyline = L.polyline(data.path, {
                color: 'red',
                weight: 5,
                opacity: 0.7
            }).addTo(map);
            
            L.marker(data.start_point).addTo(map).bindPopup("<b>Start</b> <br>" + document.getElementById('fromInput').value.split(',')[0]).openPopup();
            L.marker(data.end_point).addTo(map).bindPopup("<b>End</b> <br>" + document.getElementById('toInput').value.split(',')[0]);
            
            document.getElementById('routeStats').style.display = 'block';
            document.getElementById('distVal').textContent = data.distance + ' km';
            document.getElementById('durVal').textContent = data.duration + ' min'; // Removed backend string formatting dependency for cleaner UI
            
            map.fitBounds(routePolyline.getBounds(), {
                padding: [50, 50],
                zoom: 10
            });
        }

    } catch (error) {
        console.error("Error loading route:", error);
        alert("Could not load route. Check Python console.");
    } finally {
        document.body.style.cursor = 'default';
    }
}
async function viewStops(docId) {
    const stopsModal = new bootstrap.Modal(document.getElementById('stopsModal'));
    stopsModal.show();
    
    document.getElementById('stopsLoading').style.display = 'block';
    document.getElementById('stopsTimeline').innerHTML = '';

    try {
        const response = await fetch('/api/get-bus-stops', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ docId: docId }) 
        });
        
        const responseData = await response.json();
        
        document.getElementById('stopsLoading').style.display = 'none';
        
        const stopsList = responseData.data || [];

        if (stopsList.length === 0) {
            document.getElementById('stopsTimeline').innerHTML = '<p class="text-center text-muted">No stops information available.</p>';
            return;
        }
        stopsList.sort((a, b) => {
            return Number(a.seqNo) - Number(b.seqNo);
        });
        let timelineHtml = '';
        
        stopsList.forEach(stop => {
            const stopName = stop.placeName || "Unknown Stop";
            const time = stop.scheduleArrTime || "--:--"; 
            
            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-time">${time}</div>
                    <div class="timeline-content">
                        <strong>${stopName}</strong>
                    </div>
                </div>
            `;
        });

        document.getElementById('stopsTimeline').innerHTML = timelineHtml;

    } catch (error) {
        console.error("Error fetching stops:", error);
        document.getElementById('stopsLoading').style.display = 'none';
        document.getElementById('stopsTimeline').innerHTML = '<div class="alert alert-danger">Error loading details.</div>';
    }
} 
async function searchBuses() {
            const resultsDiv = document.getElementById('busResults');
            resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-danger"></div><p>Fetching Buses...</p></div>'; 
            
            const sourceNameRaw = document.getElementById('fromInput').value;
            const destNameRaw = document.getElementById('toInput').value;
            const sourceCity = sourceNameRaw.split(',')[0].trim();
            const destCity = destNameRaw.split(',')[0].trim();
            

            try {
                let apiUrl,response,rawResponse,busData,payload;
                 //apiUrl = '/api/find-buses';
                 if (fromState === 'KSRTC' || toState === 'KSRTC'){
                    apiUrl='api/find-buses-kerala';
                payload = {
                fromName: document.getElementById('fromInput').value,
                toName: document.getElementById('toInput').value
            };
            console.log('Searching Kerala buses:', payload);
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        else if (fromState === 'TNSTC' || toState === 'TNSTC') {
            console.log('Using TNSTC API');
            apiUrl = '/api/find-buses-tnstc';
            payload = {
                fromName: document.getElementById('fromInput').value,
                toName: document.getElementById('toInput').value
            };
            
            console.log('TNSTC Payload:', JSON.stringify(payload, null, 2));

            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log('Response Status:', response.status);
             if (!response.ok) {
        const errorText = await response.text();
        console.error('Error Response:', errorText);
        throw new Error(`Server returned ${response.status}: ${errorText}`);
    }
        }
    else if (fromState === 'TGSRTC' || toState === 'TGSRTC') {
    console.log('üü£ Using TGSRTC Local DB');
    apiUrl = '/api/find-buses-tgsrtc';
    payload = {
        fromId: fromApsrtcId,
        toId: toApsrtcId
    };

    response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
}
        else if (fromState === 'KSRTC-KA' || toState === 'KSRTC-KA') {
    console.log(' Using KSRTC Karnataka API');
    apiUrl = '/api/find-buses-ksrtc-karnataka';
    
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];

    payload = {
        fromName: document.getElementById('fromInput').value,
        toName: document.getElementById('toInput').value,
        journeyDate: dateStr
    };

    response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
}
            else if(fromState === 'APSRTC' && toState === 'APSRTC'){
                console.log('Using APSRTC API');
                if(!fromApsrtcId || !toApsrtcId) {
                console.log("Waiting for both IDs...");
                resultsDiv.innerHTML = '<div class="alert alert-warning">Spelling mistake or this state is yet to be integrated.</div>';
                return;
            }
            apiUrl='/api/find-buses'
        payload = {
            fromId: fromApsrtcId,
            toId: toApsrtcId,
            fromName: sourceCity,
            toName: destCity
        }
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }
            else {
            console.log('Not known state combination');
            resultsDiv.innerHTML = '<div class="alert alert-warning">This route combination is not yet supported.</div>';
            return;
        }
                rawResponse = await response.json();
                busData = [];
                 if (rawResponse.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${rawResponse.error}</div>`;
            return;
        }
                if (rawResponse.data && Array.isArray(rawResponse.data)) {
                    busData = rawResponse.data;
                } else if (Array.isArray(rawResponse)) {
                    busData = rawResponse;
                }

                if(busData.length > 0) {
                    const now = new Date();
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();
                    var displayFare;
                    busData.forEach(bus => {
                        let displayFare = bus.fare;
                        if (displayFare === 'N/A' && rawResponse.averageFare) {
                            displayFare = `~${rawResponse.averageFare}`;
                                    }
                        if(!bus.serviceStartTime) { bus.minutes = 9999; return; }
                        
                        const [h, m] = bus.serviceStartTime.split(':').map(Number);
                        bus.minutes = h * 60 + m;
                        bus.isPast = bus.minutes < currentMinutes;
                    });

                    busData.sort((a, b) => {
                        if (a.isPast === b.isPast) return a.minutes - b.minutes;
                        return a.isPast ? 1 : -1;
                    });
                    
                    
          busData.forEach(bus => {
                if (!bus.serviceStartTime || bus.serviceStartTime === "N/A") {
                    bus.minutes = 9999;
                    bus.isPast = true;
                    return;
                }

                let timeStr = bus.serviceStartTime.trim();
                let hours = 0, minutes = 0;
                
                // Check if AM/PM format
                const ampm = timeStr.toLowerCase().includes('am') || timeStr.toLowerCase().includes('pm');
                if (ampm) {
                    const isPM = timeStr.toLowerCase().includes('pm');
                    const cleanTime = timeStr.replace(/am|pm/gi, '').trim();
                    const parts = cleanTime.split(':');
                    hours = parseInt(parts[0]);
                    minutes = parts.length > 1 ? parseInt(parts[1]) : 0;
                    if (isPM && hours !== 12) hours += 12;
                    if (!isPM && hours === 12) hours = 0;
                } else {
                    const parts = timeStr.split(':');
                    hours = parseInt(parts[0]);
                    minutes = parts.length > 1 ? parseInt(parts[1]) : 0;
                }

                bus.minutes = hours * 60 + minutes;
                bus.isPast = bus.minutes < currentMinutes;
            });

            busData.sort((a, b) => {
                if (a.isPast === b.isPast) return a.minutes - b.minutes;
                return a.isPast ? 1 : -1;
            });

            let html = `<h6 class="text-muted mb-3 px-2">Found ${busData.length} buses from <strong> ${sourceCity}</strong></h6>`;
            if (rawResponse.totalPages) {
                html += ` (${rawResponse.totalPages} pages)`;
            }
            html += `</h6>`;

            busData.forEach(bus => {
                const cardClass = bus.isPast ? 'bus-card departed' : 'bus-card';
                
                let displayFare = "N/A";
                if (bus.fare && bus.fare !== "N/A") {
                    displayFare = `‚Çπ${bus.fare}`;
                } else if (rawResponse.averageFare) {
                    displayFare = `~‚Çπ${rawResponse.averageFare}`;
                }
                let arrivalTime = bus.serviceEndTime;
                if ((!arrivalTime || arrivalTime === "N/A") && bus.duration && bus.duration !== "N/A") {
                    arrivalTime = "Check Duration";
                }


            let stopsButton = '';
            
            if (fromState === 'APSRTC') {

                if (bus.serviceDocId && bus.serviceDocId !== 'null') {
                    stopsButton = `
                    <button class="btn btn-sm border btn-light rounded-pill px-2 py-1" 
                            style="font-size:0.75rem; font-weight: 600;" 
                            onclick="viewStops('${bus.serviceDocId}')">
                        View Stops
                    </button>`;
                } else {
                    stopsButton = `<span class="text-muted small">Stops N/A</span>`;
                }
            } else if (fromState === 'KSRTC' || toState === 'KSRTC')  {
                    if (bus.serviceDocId && bus.serviceDocId !== 'null') {
                    stopsButton = `
                    <button class="btn btn-sm border btn-light rounded-pill px-2 py-1" 
                            style="font-size:0.75rem; font-weight: 600;" 
                            onclick="viewKeralaBusStops('${bus.serviceDocId}')">
                        View Stops
                    </button>`;
                } else {
                    stopsButton = `<span class="text-muted small">Stops N/A</span>`;
                }
            }
            else if (fromState === 'KSRTC-KA' || toState === 'KSRTC-KA') {
    if (bus.serviceDocId && bus.serviceDocId !== 'null') {
        stopsButton = `
        <button class="btn btn-sm border btn-warning bg-light rounded-pill px-2 py-1" 
                style="font-size:0.75rem; font-weight: 600;"
                onclick="viewKsrtcKaStops('${bus.serviceDocId}')">
            View Route
        </button>`;
    } else {
        stopsButton = `<span class="text-muted small">Route Info N/A</span>`;
    }
}

             else if (fromState === 'TNSTC' || toState === 'TNSTC') {
                    stopsButton = `<span class="text-muted small">‚è≥ Stops coming soon</span>`;
                }
                else if (fromState === 'KSRTC-KA' || toState === 'KSRTC-KA') {
    stopsButton = `<span class="badge bg-light text-dark border">Amenities in details</span>`;
}




html += `
<div class="${cardClass}">
    <div class="bus-header">
        <div>
            <div class='text-muted fw-bold small'>Bus Service</div>
            <div class="service-code">${bus.oprsNo || 'N/A'}</div>
        </div>
        <div class="service-type">${bus.serviceType || 'BUS'}</div>
    </div>
    
    <div class="bus-body">
        <div class="time-group">
            <div class="time-label">Departs</div>
            <div class="time-main">${bus.serviceStartTime}</div>
        </div>
        
        <div class="journey-graphic">
            <div class="bus-icon-circle">üöå</div>
        </div>
        
        <div class="time-group">
            <div class="time-label">Arrives</div>
            <div class="time-main">${arrivalTime}</div>
        </div>
    </div>
    
    ${bus.duration && bus.duration !== 'N/A' ? `
    <div class="mt-2 text-muted small">
        <i class="bi bi-clock"></i> ${bus.duration}
    </div>` : ''}
    
    ${bus.route ? `
    <div class="mt-1 text-muted" style="font-size: 0.8rem;">
        <i class="bi bi-signpost"></i> ${bus.route}
    </div>` : ''}
    
    <div class="mt-2 pt-2 border-top d-flex justify-content-between align-items-center">
        <span class="text-muted small">üíµ Fare:</span>
        <span class="fw-bold text-success" style="font-size: 1.1rem;">${displayFare}</span>
        ${stopsButton}
    </div>
</div>`;
            });

            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-secondary text-center">No buses found.</div>`;
        }

    } catch (error) {
        console.error("Bus search failed:", error);
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

async function viewKeralaBusStops(detailUrl) {
    console.log('Fetching stops from:', detailUrl); // Debug log
    
    if (!detailUrl || detailUrl === 'null' || detailUrl === 'undefined') {
        alert('Bus stop information not available for this service.');
        return;
    }
    
    const stopsModal = new bootstrap.Modal(document.getElementById('stopsModal'));
    stopsModal.show();
    
    document.getElementById('stopsLoading').style.display = 'block';
    document.getElementById('stopsTimeline').innerHTML = '';

    try {
        const response = await fetch('/api/get-kerala-bus-stops', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ detailUrl: detailUrl })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('Stops data:', responseData); // Debug log
        
        document.getElementById('stopsLoading').style.display = 'none';
        
        const stopsList = responseData.data || [];

        if (stopsList.length === 0) {
            document.getElementById('stopsTimeline').innerHTML = 
                '<p class="text-center text-muted">No stops information available.</p>';
            return;
        }

        let timelineHtml = '';
        stopsList.forEach((stop, index) => {
            const stopName = stop.placeName || "Unknown Stop";
            const time = stop.scheduleArrTime || "--:--";
            
            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    ${time !== '--:--' ? `<div class="timeline-time">${time}</div>` : ''}
                    <div class="timeline-content">
                        <strong>${index + 1}. ${stopName}</strong>
                    </div>
                </div>
            `;
        });

        document.getElementById('stopsTimeline').innerHTML = timelineHtml;

    } catch (error) {
        console.error("Error fetching stops:", error);
        document.getElementById('stopsLoading').style.display = 'none';
        document.getElementById('stopsTimeline').innerHTML = 
            `<div class="alert alert-danger">Error loading stops: ${error.message}</div>`;
    }
}

async function viewKsrtcKaStops(routeCode) {
    const stopsModal = new bootstrap.Modal(document.getElementById('stopsModal'));
    stopsModal.show();
    
    document.getElementById('stopsLoading').style.display = 'block';
    document.getElementById('stopsTimeline').innerHTML = '';

    try {
        const response = await fetch('/api/get-ksrtc-ka-stops', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ routeCode: routeCode })
        });
        
        const responseData = await response.json();
        document.getElementById('stopsLoading').style.display = 'none';
        
        const stopsList = responseData.data || [];

        if (stopsList.length === 0) {
            document.getElementById('stopsTimeline').innerHTML = '<p class="text-center text-muted">No intermediate stops information available.</p>';
            return;
        }

        let timelineHtml = '';
        
        stopsList.forEach((stop) => {
            const stopName = stop.placeName;
            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-dot" style="background: #ffc107; border-color: #fff;"></div>
                    <div class="timeline-time">Stop ${stop.seqNo}</div>
                    <div class="timeline-content">
                        <strong>${stopName}</strong>
                    </div>
                </div>
            `;
        });

        document.getElementById('stopsTimeline').innerHTML = timelineHtml;

    } catch (error) {
        console.error("Error fetching KSRTC stops:", error);
        document.getElementById('stopsLoading').style.display = 'none';
        document.getElementById('stopsTimeline').innerHTML = '<div class="alert alert-danger">Error loading route details.</div>';
    }
}
async function viewKsrtcKaStops(routeCode) {
    const stopsModal = new bootstrap.Modal(document.getElementById('stopsModal'));
    stopsModal.show();
    
    document.getElementById('stopsLoading').style.display = 'block';
    document.getElementById('stopsTimeline').innerHTML = '';

    try {
        const response = await fetch('/api/get-ksrtc-ka-stops', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ routeCode: routeCode })
        });
        
        const responseData = await response.json();
        document.getElementById('stopsLoading').style.display = 'none';
        
        const stopsList = responseData.data || [];

        if (stopsList.length === 0) {
            document.getElementById('stopsTimeline').innerHTML = '<p class="text-center text-muted">No intermediate stops information available.</p>';
            return;
        }

        let timelineHtml = '';
        
        stopsList.forEach((stop) => {
            const stopName = stop.placeName;
            
            // This API doesn't give time, so we show sequence number or just a dot
            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-dot" style="background: #ffc107; border-color: #fff;"></div>
                    <div class="timeline-time">Stop ${stop.seqNo}</div>
                    <div class="timeline-content">
                        <strong>${stopName}</strong>
                    </div>
                </div>
            `;
        });

        document.getElementById('stopsTimeline').innerHTML = timelineHtml;

    } catch (error) {
        console.error("Error fetching KSRTC stops:", error);
        document.getElementById('stopsLoading').style.display = 'none';
        document.getElementById('stopsTimeline').innerHTML = '<div class="alert alert-danger">Error loading route details.</div>';
    }
}
    </script>
<div class="modal fade" id="stopsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Bus Stops & Schedule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="stopsLoading" class="text-center py-4">
                    <div class="spinner-border text-danger" role="status"></div>
                </div>
                <div id="stopsTimeline" class="timeline">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>